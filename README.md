# ğŸ¤ ASR Gateway - å·¥ä¸šçº§è¯­éŸ³è¯†åˆ«ç½‘å…³

ASR Gateway æ˜¯ä¸€ä¸ª**å¾®æœåŠ¡æ¶æ„**çš„è¯­éŸ³è¯†åˆ«ç³»ç»Ÿï¼Œå°† FunASR çš„ WebSocket æœåŠ¡å°è£…ä¸ºæ ‡å‡† HTTP æ¥å£ï¼Œæ”¯æŒ **MP3/WAV** æ–‡ä»¶ä¸Šä¼ ï¼Œå…·å¤‡å®Œæ•´çš„å¼€å‘ã€æµ‹è¯•ã€æ‰“åŒ…ã€éƒ¨ç½²æµç¨‹ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASR Gateway å¾®æœåŠ¡æ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Nginx (è´Ÿè½½å‡è¡¡)     â”‚  Gateway (ä¸šåŠ¡é€»è¾‘)   â”‚  FunASR (æ ¸å¿ƒæœåŠ¡) â”‚
â”‚  - åå‘ä»£ç†          â”‚  - HTTP API æ¥å£      â”‚  - è¯­éŸ³è¯†åˆ«å¼•æ“     â”‚
â”‚  - è´Ÿè½½å‡è¡¡          â”‚  - è®¤è¯é‰´æƒ          â”‚  - WebSocket æœåŠ¡   â”‚
â”‚  - SSL ç»ˆæ­¢          â”‚  - è°ƒç”¨ç»Ÿè®¡          â”‚  - æ¨¡å‹æ¨ç†        â”‚
â”‚  - å¥åº·æ£€æŸ¥          â”‚  - æ—¥å¿—ç®¡ç†          â”‚  - å¤šè¯­è¨€æ”¯æŒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
ASR/
â”œâ”€â”€ ğŸ“¦ deploy_package/           # ç¦»çº¿éƒ¨ç½²åŒ…
â”‚   â”œâ”€â”€ deploy.sh               # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ docker-compose.yml      # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ images/                 # Docker é•œåƒæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ funasr.tar         # FunASR æœåŠ¡é•œåƒ
â”‚   â”‚   â”œâ”€â”€ asr-gateway.tar    # Gateway æœåŠ¡é•œåƒ
â”‚   â”‚   â””â”€â”€ nginx.tar          # Nginx é•œåƒ
â”‚   â””â”€â”€ models/                 # æ¨¡å‹æ–‡ä»¶åŒ…
â”‚       â””â”€â”€ models.tar.gz      # å‹ç¼©çš„æ¨¡å‹æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ¤– funasr_resources/        # FunASR èµ„æºç›®å½•
â”‚   â””â”€â”€ models/                 # è¯­éŸ³è¯†åˆ«æ¨¡å‹
â”‚       â”œâ”€â”€ damo/               # è¾¾æ‘©é™¢æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ SenseVoiceSmall-onnx/          # ä¸»è¯†åˆ«æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ speech_fsmn_vad_zh-cn-16k-common-onnx/  # VAD æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ speech_ngram_lm_zh-cn-ai-wesp-fst/      # è¯­è¨€æ¨¡å‹
â”‚       â”‚   â””â”€â”€ speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-onnx/
â”‚       â””â”€â”€ thuduj12/           # æ¸…åå¤§å­¦æ¨¡å‹
â”‚           â””â”€â”€ fst_itn_zh/     # é€†æ–‡æœ¬æ ‡å‡†åŒ–æ¨¡å‹
â”‚
â”œâ”€â”€ ğŸŒ gateway_app/             # Gateway åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ logging_conf.py         # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ auth.py                 # API è®¤è¯
â”‚   â”œâ”€â”€ asr_client.py           # FunASR WebSocket å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ usage.py                # è°ƒç”¨ç»Ÿè®¡
â”‚   â”œâ”€â”€ routes/                 # API è·¯ç”±
â”‚   â”‚   â””â”€â”€ asr_service.py     # ASR æœåŠ¡æ¥å£
â”‚   â””â”€â”€ Dockerfile              # Gateway å®¹å™¨é•œåƒ
â”‚
â”œâ”€â”€ ğŸ—ï¸ infra/                   # åŸºç¡€è®¾æ–½é…ç½®
â”‚   â”œâ”€â”€ docker-compose.yml      # å¼€å‘ç¯å¢ƒç¼–æ’
â”‚   â”œâ”€â”€ nginx/                  # Nginx é…ç½®
â”‚   â”‚   â””â”€â”€ nginx.conf         # è´Ÿè½½å‡è¡¡é…ç½®
â”‚   â””â”€â”€ logs/                   # å®¹å™¨æ—¥å¿—ç›®å½•
â”‚
â”œâ”€â”€ ğŸ”§ scripts/                 # è¿ç»´è„šæœ¬
â”‚   â”œâ”€â”€ check.sh               # å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ restart.sh             # æœåŠ¡é‡å¯
â”‚   â””â”€â”€ stop.sh                # æœåŠ¡åœæ­¢
â”‚
â”œâ”€â”€ ğŸ“Š logs/                    # åº”ç”¨æ—¥å¿—
â”‚   â””â”€â”€ asr_gateway.log        # Gateway è¿è¡Œæ—¥å¿—
â”‚
â”œâ”€â”€ ğŸš€ run_gateway.sh           # æœ¬åœ°å¼€å‘å¯åŠ¨è„šæœ¬
â”œâ”€â”€ ğŸ“¦ package.sh               # ä¸€é”®æ‰“åŒ…è„šæœ¬
â””â”€â”€ ğŸ“‹ requirements.txt         # Python ä¾èµ–
```

---

## ğŸ¯ å„ç»„ä»¶ä½œç”¨

### ğŸ³ **deploy_package** - ç¦»çº¿éƒ¨ç½²åŒ…
- **ç›®çš„**ï¼šæ”¯æŒç½‘ç»œéš”ç¦»ç¯å¢ƒçš„ç¦»çº¿éƒ¨ç½²
- **å†…å®¹**ï¼šåŒ…å«æ‰€æœ‰ Docker é•œåƒã€æ¨¡å‹æ–‡ä»¶ã€é…ç½®æ–‡ä»¶
- **ä½¿ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒã€å†…ç½‘éƒ¨ç½²ã€æ— ç½‘ç»œç¯å¢ƒ

### ğŸ¤– **funasr_resources** - FunASR èµ„æº
- **ç›®çš„**ï¼šå­˜å‚¨è¯­éŸ³è¯†åˆ«æ¨¡å‹æ–‡ä»¶
- **å†…å®¹**ï¼šASR æ¨¡å‹ã€VAD æ¨¡å‹ã€è¯­è¨€æ¨¡å‹ã€ITN æ¨¡å‹
- **æŒ‚è½½æ–¹å¼**ï¼šé€šè¿‡ Docker å·æŒ‚è½½åˆ° FunASR å®¹å™¨

### ğŸŒ **gateway_app** - ç½‘å…³åº”ç”¨
- **ç›®çš„**ï¼šHTTP API ç½‘å…³ï¼Œä¸šåŠ¡é€»è¾‘å±‚
- **åŠŸèƒ½**ï¼š
  - æ–‡ä»¶ä¸Šä¼ æ¥æ”¶
  - API è®¤è¯é‰´æƒ
  - è°ƒç”¨ FunASR WebSocket
  - è°ƒç”¨ç»Ÿè®¡å’Œæ—¥å¿—
  - é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼åŒ–

### ğŸ—ï¸ **infra** - åŸºç¡€è®¾æ–½
- **ç›®çš„**ï¼šå®¹å™¨ç¼–æ’å’ŒåŸºç¡€è®¾æ–½é…ç½®
- **å†…å®¹**ï¼š
  - Docker Compose é…ç½®
  - Nginx è´Ÿè½½å‡è¡¡é…ç½®
  - å®¹å™¨æ—¥å¿—ç®¡ç†

### ğŸ”§ **scripts** - è¿ç»´è„šæœ¬
- **ç›®çš„**ï¼šè‡ªåŠ¨åŒ–è¿ç»´æ“ä½œ
- **åŠŸèƒ½**ï¼šå¥åº·æ£€æŸ¥ã€æœåŠ¡é‡å¯ã€çŠ¶æ€ç›‘æ§

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ æœ¬åœ°å¼€å‘æµ‹è¯•

```bash
# å¯åŠ¨ FunASR æœåŠ¡
cd infra
docker-compose up -d funasr

# å¯åŠ¨ Gateway å¼€å‘æœåŠ¡ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
./run_gateway.sh
```

### 2ï¸âƒ£ å®Œæ•´ç¯å¢ƒéƒ¨ç½²

```bash
# å¯åŠ¨å®Œæ•´æœåŠ¡æ ˆ
cd infra
docker-compose --profile dev up -d

# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:8080/healthz
```

### 3ï¸âƒ£ ç¦»çº¿éƒ¨ç½²

```bash
# 1. æœ¬åœ°æ‰“åŒ…
./package.sh

# 2. ä¼ è¾“åˆ°ç›®æ ‡æœºå™¨
scp -r deploy_package/ user@target-server:/path/to/deploy/

# 3. ç›®æ ‡æœºå™¨éƒ¨ç½²
cd /path/to/deploy/deploy_package
./deploy.sh
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### ğŸ“‹ API æ¥å£æµ‹è¯•

#### 1. å¥åº·æ£€æŸ¥
```bash
curl http://127.0.0.1:8080/healthz
# æœŸæœ›è¿”å›: {"status": "ok"}
```

#### 2. è¯­éŸ³è¯†åˆ«æµ‹è¯•
```bash
curl -X POST "http://127.0.0.1:8080/asr" \
  -H "X-API-Key: hejia123" \
  -F "file=@/path/to/test.wav"

# æœŸæœ›è¿”å›:
# {
#   "code": 0,
#   "message": "success",
#   "data": {
#     "user": "hejia",
#     "filename": "test.wav",
#     "elapsed": 2.039,
#     "result": "è¯†åˆ«ç»“æœæ–‡æœ¬"
#   }
# }
```

#### 3. è°ƒç”¨ç»Ÿè®¡
```bash
curl -H "X-API-Key: hejia123" http://127.0.0.1:8080/summary

# æœŸæœ›è¿”å›:
# {
#   "user": "hejia",
#   "date": "2024-01-01",
#   "count": 5,
#   "avg_latency": 1.8
# }
```

### ğŸ” æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆéœ€è¦å…ˆå®‰è£… bc å·¥å…·ï¼‰
./scripts/benchmark.sh 5 20  # 5ä¸ªå¹¶å‘ï¼Œæ€»å…±20ä¸ªè¯·æ±‚
```

### ğŸ¥ å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
./scripts/check.sh

# æŒç»­ç›‘æ§
./scripts/monitor.sh 30  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### ğŸ”‘ API è®¤è¯é…ç½®

```bash
# è®¾ç½® API Keysï¼ˆæ”¯æŒå¤šç”¨æˆ·ï¼‰
export ASR_API_KEYS="user1:key1,user2:key2,admin:admin123"

# è¯·æ±‚æ—¶ä½¿ç”¨
curl -H "X-API-Key: key1" ...
```

### ğŸ›ï¸ æœåŠ¡é…ç½®

```bash
# FunASR æœåŠ¡å™¨åœ°å€
export FUNASR_SERVER="wss://127.0.0.1:10095"

# æœ€å¤§å¹¶å‘æ•°
export MAX_CONCURRENCY=8

# æ—¥å¿—çº§åˆ«
export LOG_LEVEL="INFO"
```

### ğŸ³ Docker é…ç½®

```yaml
# infra/docker-compose.yml
services:
  funasr:
    image: registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-cpu-0.4.7
    ports:
      - "10095:10095"
    volumes:
      - ../funasr_resources/models:/workspace/models

  asr_gateway_dev:
    profiles: ["dev"]
    ports:
      - "22800:22800"
    environment:
      - FUNASR_SERVER=wss://funasr:10095

  nginx_dev:
    profiles: ["dev"]
    ports:
      - "8080:80"
```

---

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### ğŸ“ˆ æ—¥å¿—æŸ¥çœ‹

```bash
# Gateway æ—¥å¿—
tail -f logs/asr_gateway.log

# å®¹å™¨æ—¥å¿—
docker logs -f asr_gateway_dev
docker logs -f funasr

# Nginx æ—¥å¿—
tail -f infra/logs/access.log
```

### ğŸ”„ æœåŠ¡ç®¡ç†

```bash
# é‡å¯æœåŠ¡
./scripts/restart.sh

# åœæ­¢æœåŠ¡
./scripts/stop.sh

# æ£€æŸ¥çŠ¶æ€
./scripts/check.sh
```

### ğŸ“¦ æ‰“åŒ…éƒ¨ç½²

```bash
# æœ¬åœ°æ‰“åŒ…
./package.sh

# æŸ¥çœ‹æ‰“åŒ…ç»“æœ
ls -lh deploy_package/
```

---

## ğŸŒŸ ç‰¹æ€§äº®ç‚¹

### âœ¨ **å¼€å‘å‹å¥½**
- ğŸ”¥ **çƒ­é‡è½½**ï¼šæœ¬åœ°å¼€å‘æ”¯æŒä»£ç å®æ—¶æ›´æ–°
- ğŸ› **è°ƒè¯•æ¨¡å¼**ï¼šè¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œå †æ ˆä¿¡æ¯
- ğŸ“– **API æ–‡æ¡£**ï¼šè‡ªåŠ¨ç”Ÿæˆçš„ Swagger UI

### ğŸ­ **ç”Ÿäº§å°±ç»ª**
- ğŸ³ **å®¹å™¨åŒ–**ï¼šå®Œæ•´çš„ Docker éƒ¨ç½²æ–¹æ¡ˆ
- ğŸ“¦ **ç¦»çº¿éƒ¨ç½²**ï¼šæ”¯æŒç½‘ç»œéš”ç¦»ç¯å¢ƒ
- ğŸ”„ **é«˜å¯ç”¨**ï¼šNginx è´Ÿè½½å‡è¡¡ï¼Œå¤šå®ä¾‹éƒ¨ç½²
- ğŸ“Š **ç›‘æ§å®Œå–„**ï¼šå¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§ã€æ—¥å¿—èšåˆ

### ğŸ”’ **å®‰å…¨å¯é **
- ğŸ” **API è®¤è¯**ï¼šå¤šç”¨æˆ· Key è®¤è¯æœºåˆ¶
- ğŸ›¡ï¸ **å¹¶å‘æ§åˆ¶**ï¼šé˜²æ­¢æœåŠ¡è¿‡è½½
- ğŸ“ **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„è°ƒç”¨è®°å½•å’Œç»Ÿè®¡

### âš¡ **é«˜æ€§èƒ½**
- ğŸš€ **å¼‚æ­¥å¤„ç†**ï¼šFastAPI å¼‚æ­¥æ¡†æ¶
- ğŸ”„ **è¿æ¥æ± **ï¼šWebSocket è¿æ¥å¤ç”¨
- ğŸ“Š **æ€§èƒ½ç›‘æ§**ï¼šå“åº”æ—¶é—´ç»Ÿè®¡å’Œä¼˜åŒ–

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. **å¼€å‘ç¯å¢ƒè®¾ç½®**ï¼šä½¿ç”¨ `run_gateway.sh` å¯åŠ¨å¼€å‘ç¯å¢ƒ
2. **ä»£ç è§„èŒƒ**ï¼šéµå¾ª Python PEP 8 è§„èŒƒ
3. **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ–°åŠŸèƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–° README å’Œ API æ–‡æ¡£

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- ğŸ› **é—®é¢˜åé¦ˆ**ï¼šGitHub Issues
- ğŸ“§ **é‚®ä»¶è”ç³»**ï¼šyour-email@example.com
- ğŸ’¬ **æŠ€æœ¯äº¤æµ**ï¼šåŠ å…¥æˆ‘ä»¬çš„æŠ€æœ¯äº¤æµç¾¤

---

**ğŸ‰ æ„Ÿè°¢ä½¿ç”¨ ASR Gatewayï¼è®©è¯­éŸ³è¯†åˆ«å˜å¾—ç®€å•é«˜æ•ˆã€‚**